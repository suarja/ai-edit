# Usage Tracking Implementation for TestFlight

## Overview

This document outlines the implementation plan for a usage tracking system to limit video generation in the TestFlight version of AI Edit without requiring payment integration. The system will track the number of videos generated by each user and enforce configurable usage limits.

## Implementation Details

### Database Schema

The `user_usage` table has been implemented in Supabase with the following structure:

```sql
CREATE TABLE user_usage (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  videos_generated INTEGER NOT NULL DEFAULT 0,
  videos_limit INTEGER NOT NULL DEFAULT 5,
  last_reset_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  next_reset_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() + INTERVAL '30 days'),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

### Automatic Usage Record Creation

A database trigger automatically creates a usage record for each new user:

```sql
CREATE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO user_usage (user_id)
  VALUES (NEW.id);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

### Automatic Usage Reset

A database trigger automatically resets the usage when the reset date is reached:

```sql
CREATE FUNCTION reset_user_usage()
RETURNS TRIGGER AS $$
BEGIN
  IF now() >= NEW.next_reset_date THEN
    NEW.videos_generated := 0;
    NEW.last_reset_date := now();
    NEW.next_reset_date := now() + INTERVAL '30 days';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_user_usage_update
  BEFORE UPDATE ON user_usage
  FOR EACH ROW EXECUTE FUNCTION reset_user_usage();
```

### API Integration

The video generation API (`app/api/videos/generate+api.ts`) has been updated to:

1. Check if the user has reached their usage limit before generating a video
2. Increment the usage counter after successful video generation

```typescript
// Check usage limits
const { data: usage } = await supabase
  .from('user_usage')
  .select('videos_generated, videos_limit, next_reset_date')
  .eq('user_id', user.id)
  .single();

if (usage.videos_generated >= usage.videos_limit) {
  return errorResponse(
    `Monthly video generation limit reached (${usage.videos_generated}/${
      usage.videos_limit
    }). Please wait until ${new Date(
      usage.next_reset_date
    ).toLocaleDateString()} for your limit to reset.`,
    HttpStatus.FORBIDDEN
  );
}

// ... Generate video ...

// Update usage counter
await supabase
  .from('user_usage')
  .update({
    videos_generated: usage.videos_generated + 1,
    updated_at: new Date().toISOString(),
  })
  .eq('user_id', user.id);
```

### UI Components

#### UsageDashboard Component

A new `UsageDashboard` component (`components/UsageDashboard.tsx`) displays:

- Current usage count
- Usage limit
- Visual progress bar
- Status indicator based on usage percentage
- Next reset date

#### Admin Interface

An admin interface has been added to the settings screen that allows administrators to:

1. Search for users by ID
2. View their current usage data
3. Adjust their usage limits

The `AdminUsageControl` component (`components/AdminUsageControl.tsx`) provides the interface for adjusting limits.

### Security

Row-level security policies have been implemented to:

1. Allow users to see only their own usage data
2. Allow users to update only their own usage data (although API-controlled)
3. Allow admins to see and modify all usage data

## TestFlight Configuration

The default usage limit for TestFlight users is set to 5 videos per month, which can be adjusted by administrators as needed during the beta testing phase.

## Next Steps

1. Monitor usage patterns during beta testing to determine appropriate limits
2. Collect feedback from testers on the clarity of usage limitations
3. Prepare for transition to full payment system after TestFlight

## Testing Plan

1. **Unit Tests**:

   - Test database triggers for user creation and usage reset
   - Test API endpoints for proper validation and error handling
   - Test UI components for correct rendering of usage data

2. **Integration Tests**:

   - Verify usage counter increments properly with video generation
   - Test limit enforcement when maximum is reached
   - Verify reset date logic works correctly

3. **End-to-End Tests**:
   - Complete flow from user signup to reaching usage limit
   - Admin control functionality
   - Edge cases for users with existing records

## Deployment Steps

1. Apply database migrations to create the `user_usage` table
2. Deploy updated API endpoints for usage checking and tracking
3. Add UI components to display usage information
4. Test the complete flow before TestFlight submission
5. Include usage limits in TestFlight invitation notes
